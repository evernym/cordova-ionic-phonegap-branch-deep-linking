{"version":3,"sources":["lib/ios/xcodePreferences.js"],"names":[],"mappings":";;AAAA;;;;;;;;AAQA,CAAC,YAAW;;AAEV,MAAI,OAAO,QAAQ,MAAR,CAAX;AAAA,MACE,UAAU,QAAQ,sBAAR,CADZ;AAAA,MAEE,kBAAkB,QAAQ,uBAAR,CAFpB;;AAGE;AACA,0BAAwB,KAJ1B;AAAA,MAKE,cAAc,WALhB;AAAA,MAME,OANF;;AAQA,SAAO,OAAP,GAAiB;AACf,wCAAoC;AADrB,GAAjB;;AAIA;;AAEA;;;;;AAKA,WAAS,kCAAT,CAA4C,cAA5C,EAA4D;AAC1D,cAAU,cAAV;;AAEA,QAAI,cAAc,iBAAlB;;AAEA;AACA,+BAA2B,YAAY,KAAvC;;AAEA;AACA,oBAAgB,YAAY,KAA5B;;AAEA;AACA,gBAAY,KAAZ;AACD;;AAED;;AAEA;;AAEA;;;;;;;AAOA,WAAS,0BAAT,CAAoC,YAApC,EAAkD;AAChD,QAAI,iBAAiB,YAAY,aAAa,8BAAb,EAAZ,CAArB;AAAA,QACE,uBAAuB,wBADzB;AAAA,QAEE,MAFF;AAAA,QAGE,aAHF;AAAA,QAIE,yBAJF;;AAMA,SAAK,MAAL,IAAe,cAAf,EAA+B;AAC7B,sBAAgB,eAAe,MAAf,EAAuB,aAAvC;AACA,oBAAc,wBAAd,IAA0C,MAAM,oBAAN,GAA6B,GAAvE;AACA;AACA,UAAI,cAAc,4BAAd,CAAJ,EAAiD;AAC/C,YAAI,wBAAwB,cAAc,4BAAd,EAA4C,QAA5C,EAA5B;AACA,YAAI,QAAQ,qBAAR,EAA+B,qBAA/B,KAAyD,CAAC,CAA9D,EAAiE;AAC/D,wBAAc,4BAAd,IAA8C,qBAA9C;AACA,sCAA4B,IAA5B;AACD;AACF,OAND,MAOA;AACE,sBAAc,4BAAd,IAA8C,qBAA9C;AACA,oCAA4B,IAA5B;AACD;AACF;;AAED,QAAI,yBAAJ,EAA+B;AAC7B,cAAQ,GAAR,CAAY,mDAAmD,qBAA/D;AACD;;AAED,YAAQ,GAAR,CAAY,oDAAoD,oBAAhE;AACD;;AAED;;AAEA;;AAEA;;;;;AAKA,WAAS,eAAT,CAAyB,YAAzB,EAAuC;AACrC,QAAI,uBAAuB,YAAY,aAAa,uBAAb,EAAZ,CAA3B;AAAA,QACE,+BAA+B,wBADjC;;AAGA,QAAI,yBAAyB,oBAAzB,EAA+C,4BAA/C,CAAJ,EAAkF;AAChF,cAAQ,GAAR,CAAY,4CAAZ;AACA;AACD;;AAED,YAAQ,GAAR,CAAY,2DAAZ;AACA,2BAAuB,YAAvB,EAAqC,4BAArC;AACD;;AAED;;;;;;;AAOA,WAAS,wBAAT,CAAkC,oBAAlC,EAAwD,4BAAxD,EAAsF;AACpF,QAAI,+BAA+B,KAAnC;AAAA,QACE,IADF;AAAA,QAEE,YAFF;;AAIA,SAAK,IAAL,IAAa,oBAAb,EAAmC;AACjC,qBAAe,qBAAqB,IAArB,CAAf;AACA,UAAI,aAAa,IAAb,IAAqB,aAAa,IAAb,CAAkB,OAAlB,CAA0B,4BAA1B,IAA0D,CAAC,CAApF,EAAuF;AACrF,uCAA+B,IAA/B;AACA;AACD;AACF;;AAED,WAAO,4BAAP;AACD;;AAED;;;;;;AAMA,WAAS,sBAAT,CAAgC,YAAhC,EAA8C,4BAA9C,EAA4E;AAC1E;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAa,eAAb,CAA6B,KAAK,QAAL,CAAc,4BAAd,CAA7B;AACD;;AAED;;AAEA;;;;;AAKA,WAAS,eAAT,GAA2B;AACzB,QAAI,YAAJ,EACE,WADF;;AAGA,QAAI;AACF;AACA,qBAAe,QAAQ,oBAAR,CAA6B,mCAA7B,EAAkE,KAAlE,CAAf;AACA,oBAAc,aAAa,gBAAb,CAA8B,iBAA9B,CAAd;AACD,KAJD,CAIE,OAAO,CAAP,EAAU;AACV;AACA,qBAAe,QAAQ,oBAAR,CAA6B,uCAA7B,CAAf;AACA,oBAAc,aAAa,gBAAb,CAA8B,iBAA9B,CAAd;AACD;;AAED,WAAO,WAAP;AACD;;AAED;;;;;;AAMA,WAAS,WAAT,CAAqB,GAArB,EAA0B;AACxB,QAAI,OAAO,OAAO,IAAP,CAAY,GAAZ,CAAX;AAAA,QACE,SAAS,EADX;;AAGA,SAAK,IAAI,IAAI,CAAR,EAAW,MAAM,KAAK,MAA3B,EAAmC,IAAI,GAAvC,EAA4C,GAA5C,EAAiD;AAC/C,UAAI,CAAC,YAAY,IAAZ,CAAiB,KAAK,CAAL,CAAjB,CAAL,EAAgC;AAC9B,eAAO,KAAK,CAAL,CAAP,IAAkB,IAAI,KAAK,CAAL,CAAJ,CAAlB;AACD;AACF;;AAED,WAAO,MAAP;AACD;;AAED;;AAEA;;AAEA,WAAS,eAAT,GAA2B;AACzB,WAAO,KAAK,IAAL,CAAU,aAAV,EAAyB,WAAzB,EAAsC,KAAtC,CAAP;AACD;;AAED,WAAS,WAAT,GAAuB;AACrB,WAAO,QAAQ,IAAR,CAAa,WAApB;AACD;;AAED,WAAS,sBAAT,GAAkC;AAChC,QAAI,kBAAkB,IAAI,eAAJ,CAAoB,OAApB,CAAtB;AAAA,QACE,cAAc,gBAAgB,cAAhB,EADhB;AAAA,QAEE,WAAW,cAAc,eAF3B;;AAIA,WAAO,KAAK,IAAL,CAAU,WAAV,EAAuB,WAAvB,EAAoC,QAApC,CAAP;AACD;;AAED;AAED,CAnND","file":"lib/ios/xcodePreferences.js","sourcesContent":["/*\nScript activates support for Universal Links in the application by setting proper preferences in the xcode project file.\nWhich is:\n- deployment target set to iOS 9.0\n- .entitlements file added to project PBXGroup and PBXFileReferences section\n- path to .entitlements file added to Code Sign Entitlements preference\n*/\n\n(function() {\n\n  var path = require('path'),\n    compare = require('node-version-compare'),\n    ConfigXmlHelper = require('../configXmlHelper.js'),\n    // pbxFile = require('xcode/lib/pbxFile'),\n    IOS_DEPLOYMENT_TARGET = '8.0',\n    COMMENT_KEY = /_comment$/,\n    context;\n\n  module.exports = {\n    enableAssociativeDomainsCapability: enableAssociativeDomainsCapability\n  }\n\n  // region Public API\n\n  /**\n   * Activate associated domains capability for the application.\n   *\n   * @param {Object} cordovaContext - cordova context object\n   */\n  function enableAssociativeDomainsCapability(cordovaContext) {\n    context = cordovaContext;\n\n    var projectFile = loadProjectFile();\n\n    // adjust preferences\n    activateAssociativeDomains(projectFile.xcode);\n\n    // add entitlements file to pbxfilereference\n    addPbxReference(projectFile.xcode);\n\n    // save changes\n    projectFile.write();\n  }\n\n  // endregion\n\n  // region Alter project file preferences\n\n  /**\n   * Activate associated domains support in the xcode project file:\n   * - set deployment target to ios 9;\n   * - add .entitlements file to Code Sign Entitlements preference.\n   *\n   * @param {Object} xcodeProject - xcode project preferences; all changes are made in that instance\n   */\n  function activateAssociativeDomains(xcodeProject) {\n    var configurations = nonComments(xcodeProject.pbxXCBuildConfigurationSection()),\n      entitlementsFilePath = pathToEntitlementsFile(),\n      config,\n      buildSettings,\n      deploymentTargetIsUpdated;\n\n    for (config in configurations) {\n      buildSettings = configurations[config].buildSettings;\n      buildSettings['CODE_SIGN_ENTITLEMENTS'] = '\"' + entitlementsFilePath + '\"';\n      // if deployment target is less then the required one - increase it\n      if (buildSettings['IPHONEOS_DEPLOYMENT_TARGET']) {\n        var buildDeploymentTarget = buildSettings['IPHONEOS_DEPLOYMENT_TARGET'].toString();\n        if (compare(buildDeploymentTarget, IOS_DEPLOYMENT_TARGET) == -1) {\n          buildSettings['IPHONEOS_DEPLOYMENT_TARGET'] = IOS_DEPLOYMENT_TARGET;\n          deploymentTargetIsUpdated = true;\n        }\n      }\n else {\n        buildSettings['IPHONEOS_DEPLOYMENT_TARGET'] = IOS_DEPLOYMENT_TARGET;\n        deploymentTargetIsUpdated = true;\n      }\n    }\n\n    if (deploymentTargetIsUpdated) {\n      console.log('IOS project now has deployment target set as: ' + IOS_DEPLOYMENT_TARGET);\n    }\n\n    console.log('IOS project Code Sign Entitlements now set to: ' + entitlementsFilePath);\n  }\n\n  // endregion\n\n  // region PBXReference methods\n\n  /**\n   * Add .entitlemets file into the project.\n   *\n   * @param {Object} xcodeProject - xcode project preferences; all changes are made in that instance\n   */\n  function addPbxReference(xcodeProject) {\n    var fileReferenceSection = nonComments(xcodeProject.pbxFileReferenceSection()),\n      entitlementsRelativeFilePath = pathToEntitlementsFile();\n\n    if (isPbxReferenceAlreadySet(fileReferenceSection, entitlementsRelativeFilePath)) {\n      console.log('Entitlements file is in reference section.');\n      return;\n    }\n\n    console.log('Entitlements file is not in references section, adding it');\n    createPbxFileReference(xcodeProject, entitlementsRelativeFilePath);\n  }\n\n  /**\n   * Check if .entitlemets file reference already set.\n   *\n   * @param {Object} fileReferenceSection - PBXFileReference section\n   * @param {String} entitlementsRelativeFilePath - relative path to entitlements file\n   * @return true - if reference is set; otherwise - false\n   */\n  function isPbxReferenceAlreadySet(fileReferenceSection, entitlementsRelativeFilePath) {\n    var isAlreadyInReferencesSection = false,\n      uuid,\n      fileRefEntry;\n\n    for (uuid in fileReferenceSection) {\n      fileRefEntry = fileReferenceSection[uuid];\n      if (fileRefEntry.path && fileRefEntry.path.indexOf(entitlementsRelativeFilePath) > -1) {\n        isAlreadyInReferencesSection = true;\n        break;\n      }\n    }\n\n    return isAlreadyInReferencesSection;\n  }\n\n  /**\n   * Create reference to the entitlements file in the xcode project.\n   *\n   * @param {Object} xcodeProject - xcode project preferences; all changes are made in that instance\n   * @param {String} entitlementsRelativeFilePath - relative path to entitlemets file\n   */\n  function createPbxFileReference(xcodeProject, entitlementsRelativeFilePath) {\n    // commented for now\n    // var rootGroup = nonComments(xcodeProject.pbxGroupByName('CustomTemplate')),\n    //   entitlementsPbxFile = new pbxFile(entitlementsRelativeFilePath);\n    //\n    // entitlementsPbxFile.fileRef = xcodeProject.generateUuid(),\n    //   entitlementsPbxFile.uuid = xcodeProject.generateUuid();\n    //\n    // xcodeProject.addToPbxFileReferenceSection(entitlementsPbxFile);\n    //\n    // rootGroup.children.push({\n    //   'value': entitlementsPbxFile.fileRef,\n    //   'comment': path.basename(entitlementsRelativeFilePath)\n    // });\n    xcodeProject.addResourceFile(path.basename(entitlementsRelativeFilePath));\n  }\n\n  // region Xcode project file helpers\n\n  /**\n   * Load iOS project file from platform specific folder.\n   *\n   * @return {Object} projectFile - project file information\n   */\n  function loadProjectFile() {\n    var platform_ios,\n      projectFile;\n\n    try {\n      // try pre-5.0 cordova structure\n      platform_ios = context.requireCordovaModule('cordova-lib/src/plugman/platforms')['ios'];\n      projectFile = platform_ios.parseProjectFile(iosPlatformPath());\n    } catch (e) {\n      // let's try cordova 5.0 structure\n      platform_ios = context.requireCordovaModule('cordova-lib/src/plugman/platforms/ios');\n      projectFile = platform_ios.parseProjectFile(iosPlatformPath());\n    }\n\n    return projectFile;\n  }\n\n  /**\n   * Remove comments from the file.\n   *\n   * @param {Object} obj - file object\n   * @return {Object} file object without comments\n   */\n  function nonComments(obj) {\n    var keys = Object.keys(obj),\n      newObj = {};\n\n    for (var i = 0, len = keys.length; i < len; i++) {\n      if (!COMMENT_KEY.test(keys[i])) {\n        newObj[keys[i]] = obj[keys[i]];\n      }\n    }\n\n    return newObj;\n  }\n\n  // endregion\n\n  // region Path helpers\n\n  function iosPlatformPath() {\n    return path.join(projectRoot(), 'platforms', 'ios');\n  }\n\n  function projectRoot() {\n    return context.opts.projectRoot;\n  }\n\n  function pathToEntitlementsFile() {\n    var configXmlHelper = new ConfigXmlHelper(context),\n      projectName = configXmlHelper.getProjectName(),\n      fileName = projectName + '.entitlements';\n\n    return path.join(projectName, 'Resources', fileName);\n  }\n\n  // endregion\n\n})();\n"],"sourceRoot":"/source/"}